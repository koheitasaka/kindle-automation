# Kindleスクリーンショット自動化＆OCR付きPDF生成スクリプト

## 概要
このプロジェクトは、Kindle for Macアプリケーションからのスクリーンショット取得プロセスを自動化し、手動介入なしで完結させることを目的としています。特に、最終ページに表示されるレビュー促進ダイアログ（モーダル）を画像認識で検知してスクリーンショット作業を自動停止する機能、およびOCR（光学文字認識）付きのPDFを生成する機能を提供します。

## 導入された機能

1.  **Kindle for Macウィンドウの自動キャプチャ機能**
    *   Kindleアプリケーションのウィンドウを正確に認識し、その領域のみを自動でスクリーンショットとしてキャプチャします。
2.  **ページ自動送り機能（縦書き/横書き対応）**
    *   本のフォーマット（縦書き/横書き）に応じて、適切なキーボード操作（左矢印キー / 右矢印キー）でページを自動的に送ります。
3.  **【新機能】最終ページ（レビューモーダル）検知による自動停止**
    *   スクリーンショット取得時に、Kindleアプリに表示される「レビューを促すダイアログ」の出現を画像認識技術（OpenCVのテンプレートマッチング）で検知します。
    *   モーダルが検知された場合、自動的にスクリーンショットの取得とページ送りのプロセスを停止します。
4.  **キャプチャ画像からのOCR付きPDF生成機能**
    *   キャプチャした一連のPNG画像を結合し、OCR処理を施すことで、テキスト検索が可能なPDFファイルを生成します。この機能は`make_pdf.py`スクリプトにより提供されます。

## 動作環境

*   macOS
*   Python 3.x
*   Kindle for Mac

## セットアップ

### 1. リポジトリのクローン
任意の場所にリポジトリをクローンしてください。

```bash
# 任意のディレクトリで実行（例: ホームディレクトリ、Documentsなど）
git clone https://github.com/koheitasaka/kindle-automation.git
cd kindle-automation
```

### 2. 必要なライブラリのインストール
本スクリプトはPythonで記述されており、以下のライブラリに依存します。システム環境への影響を避けるため、仮想環境でのインストールを強く推奨します。

```bash
# 仮想環境を作成 (初回のみ)
python3 -m venv venv

# 仮想環境をアクティベート
source venv/bin/activate

# 必要なライブラリをインストール
pip install opencv-python Pillow numpy
```

### 3. OCR付きPDF生成に必要な外部ツール（任意）
`make_pdf.py` を使用する場合は、以下のツールが別途必要です。

```bash
brew install imagemagick
brew install ocrmypdf
```

## 使用方法

### 1. スクリプトの実行
仮想環境をアクティベートした後、以下のコマンドで実行します。

*   **縦書きの本の場合:**
    ```bash
    python3 kindle_shot_v7_auto.py
    ```
*   **横書きの本の場合:**
    ```bash
    python3 kindle_shot_horizontal_auto.py
    ```

**実行前の準備:**
*   Kindle for Macアプリを起動し、対象の本を開いてください。
*   スクリプト開始後、Kindleアプリのウィンドウが前面に表示され、数秒後に「Kindleの本の部分を一度クリックしてください（フォーカスを当てるため）...」というメッセージが表示されます。このメッセージに従い、Kindleの表示領域を一度クリックしてフォーカスを当ててください。
*   スクリーンショットは、`~/Desktop/KindleScreenshots` (縦書き用) または `~/Desktop/KindleScreenshots_Horizontal` (横書き用) に保存されます。

### 2. OCR付きPDFの生成
スクリーンショットの取得が完了したら、`make_pdf.py`スクリプトを使用してOCR付きPDFを生成します。

```bash
# make_pdf.pyの実行例
# IMAGE_DIRはスクリーンショットが保存されているディレクトリ、OUTPUTは生成されるPDFのパスをmake_pdf.py内で設定してください。
python3 make_pdf.py
```

## ファイル構成

*   `kindle_shot_v7_auto.py`: 縦書き本用の自動スクリーンショットスクリプト
*   `kindle_shot_horizontal_auto.py`: 横書き本用の自動スクリーンショットスクリプト
*   `make_pdf.py`: キャプチャした画像からOCR付きPDFを生成するスクリプト
*   `review_modal_template_v2.png`: レビューモーダル検出用のテンプレート画像

## 注意事項
*   現在のモーダル検知は、テンプレートマッチングの類似度スコア（`threshold=0.8`）に依存しています。KindleアプリのUI変更や表示環境（例：OSのテーマ、スケーリングなど）によって検知精度が低下する可能性があります。その際は、テンプレート画像の更新や`threshold`値の調整が必要になります。
